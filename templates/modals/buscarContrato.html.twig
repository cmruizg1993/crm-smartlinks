<!-- Button trigger modal -->
<button type="button" class="btn btn-primary btn-group-sm" data-toggle="modal" data-target="#staticBackdrop">
    <i class="icon-search"></i>
</button>

<!-- Modal -->
<div class="modal fade" id="staticBackdrop"  tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="staticBackdropLabel">Buscar Contrato</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" id="modalCerrar">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row form-group">

                    <label class="col-form-label col-4">Buscar:</label>
                    <div class="col-8">
                        <input type="text" class="form-control" id="parametroContrato">
                    </div>
                </div>
                <table class="table table-hover table-bordered table-bordered">
                    <thead>
                        <tr>
                            <th>ID</th>  
                            <th>NÃºmero</th>
                            <th>Cliente</th>
                            <th>CI/RUC</th>
                            <th>Parroquia
                            </th>
                        </tr>
                    </thead>
                    <tbody id="tContratos">


                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" data-dismiss="modal" id="modalAceptar">Aceptar</button>
            </div>
        </div>
    </div>
</div>
<script>
    let detalles = [];
    $("#parametroContrato").keyup(function (){
        var param = $(this).val();
        var L = param.length;
        if ( L >= 3){
            $.ajax({
                url:'{{ path('buscar_Contrato') }}',
                type:'POST',
                contentType: 'application/x-www-form-urlencoded; charset=utf-8',
                data: { param: param },
                success: function (html){
                    $("#tContratos").html(html);
                }

            })
        }
    });
    $("#modalAceptar").click(function (){
        //alert("hola")
        let checkboxContrato = $("input[name='Contrato_id']:checked")
        if (typeof checkboxContrato !== 'undefined'){
            let contrato = $("input[name='Contrato_id']:checked").data('contrato');
            llenarDatos(contrato);
        }else{
            alert('No se ha seleccionado ninguna Contrato')
        }
    });
    function llenarDatos(contrato) {
        $("#factura_cedula").val(contrato.cliente.dni.numero);
        $("#factura_nombre").val(contrato.cliente.nombres);
        $("#factura_contrato").val(contrato.numero);
        let detalle = {
            id_servicio: contrato.plan.id,
            id_producto: null,
            codigo: contrato.plan.codigo,
            descripcion: contrato.plan.nombre,
            precio: contrato.plan.costo,
            cantidad: 1,
            subtotal: contrato.plan.costo,
            esServicio: true
        }
        agregarDetalle(detalle);
    }
    function agregarDetalle(detalle) {
        let row = document.createElement('tr');

        row.id = `row_${detalle.esServicio? detalle.id_servicio : detalle.id_producto}`;
        row.innerHTML = `
                <td>${detalle.codigo}</td>
                <td>${detalle.descripcion}</td>
                <td>${detalle.precio}</td>
                <td>${detalle.cantidad}</td>
                <td>${detalle.subtotal}</td>
            `;
        $("#tDetalles").append(row);
        detalles.push(detalle);
        $("#factura_detallesjson").val(JSON.stringify(detalles));
        totalizar();
        /*
        <td><input type="text"  class="form-control form-group-sm" onchange="establecerSerial(this, ${e.id})" ${e.esSeriado ? '':'disabled'} required></td>
        <td><input type="number" min="1" value="1" class="form-control form-group-sm" onchange="establecerCantidad(this, ${e.id})"/></td>
        <td><button type="button" class="btn btn-sm btn-danger btn-eliminar" data-id=${e.id} >Quitar</button></td>
         */
    }
    function totalizar() {
        let detallesjson = JSON.parse($("#factura_detallesjson").val());
        let total = detallesjson.reduce((prev, current) => {
            return prev + current.subtotal
        }, 0);
        $("#txtTotal").text(total.toString())
    }
</script>